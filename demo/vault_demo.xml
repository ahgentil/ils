<Module>
  <ModulePrefs title="Vault Demo"
              author_email="na.li@epfl.ch"
              author="Na Li"
              description="Shows how to use ils javascript library"
              width="500"
              height="800">
      <Require feature="opensocial" />
      <Require feature="osapi" />
    </ModulePrefs>
 <Content type="html" view="default,canvas,home,profile">
 <![CDATA[
 <script type="text/javascript" src="http://graasp.epfl.ch/gadget/libs/jquery-1.8.0.min.js"></script>
 <script type="text/javascript" src="http://graasp.epfl.ch/gadget/libs/jquery.cookie.js"></script>
 <script type="text/javascript" src="../main/ils.js"></script>
 <script type="text/javascript">

  var getQueryVariable = function(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
        }
    }
    console.log('Query variable %s not found', variable);
  };

  var getData = function() {
    // get current user and print it
    ils.getCurrentUser(function(current_user){
      console.log("print current user");
      console.log(current_user);
      $('#get_current_user').append("Current user nickname: " + current_user);
    });

    // get the ILS and print it
    ils.getIls(function(ils_space){
      console.log(ils_space);
      $('#get_ils').append("ILS id " + ils_space.id);
    });

    // get the Vault space and print it
    ils.getVault(function(vault){
      console.log(vault);
      $('#get_vault').append("Vault id " + vault.id);
    });

    // get all resources in the Vault
    ils.listVault(function(resources){
      console.log("resources in the Vault");
      console.log(resources);
      $.each(resources, function(index, value) {
        $('#list_vault').append("<div>" + value.id + " " + value.displayName + "</div>");
      });
    });

    // read a resource in the Vault
    ils.readResource(15628, function(resource){
      console.log("print the resource");
      console.log(resource);
      $('#read_resource').append("resource id and name: " + resource.id + " " + resource.displayName);
    });

    // get parent space
    ils.getParent(function(parent){
      console.log("print parent");
      console.log(parent);
      $('#get_parent').append("parent id and name: " + parent.id + " " + parent.displayName);
    });

    // get parent inquiry phase
    ils.getParentInquiryPhase(function(phase){
      console.log("print parent phase");
      console.log(phase);
      $('#get_parent_phase').append(phase);
    });

    // create resource in Vault
    var action = "/rpc?method=documents.create&id=documents.create";
    action = action + "&st=" + getQueryVariable("st");
    
    var form = document.getElementById('file_form');
    form.setAttribute("action", action);
    var request={"method":"documents.create",
      "params": {
        "document": {
          "displayName": "test_file3",
          "parentId": 9569,
          "mimeType": "txt",
          "fileName": "my file",
          "content": "adfakdjfljlksdjfl"
        }
      },
      "id":"documents.create"
    }
    // add request payload to the form
    $('#request').val(JSON.stringify(request));
    form.submit();
  };

  // console.log(gadgets);
  gadgets.util.registerOnLoadHandler(getData);

  </script>
  <div id="get_current_user"><b>ils.getCurrentUser:</b> </div>
  <div id="get_ils"><b>ils.getIls:</b> </div>
  <div id="get_vault"><b>ils.getVault:</b> </div>
  <div id="list_vault"><b>ils.listVault:</b> </div>
  <div id="read_resource"><b>ils.readResource:</b> </div>
  <div id="get_parent"><b>ils.getParent:</b> </div>
  <div id="get_parent_phase"><b>ils.getParentInquiryPhase:</b> </div>
  <form method="post" action="/" id="file_form" enctype = "multipart/form-data">
    <input id="request" type="hidden" name="request"></input>
  </form>
  <br />
  ]]>
  </Content>
</Module>